# Детальный план разработки Telegram бота для нарезки видео

## 1. Общее описание проекта

### Цель проекта
Создание автоматизированного Telegram бота для массовой обработки видеоконтента с преобразованием в формат YouTube Shorts/TikTok с автоматическими субтитрами и профессиональным оформлением.

### Ключевые особенности
- Полная автоматизация процесса от ссылки до готового контента
- Массовая обработка с поддержкой очередей
- Профессиональное качество выходных видео
- Интеграция с облачными сервисами для хранения
- Административная панель для контроля процессов


---

## 2. Детальное описание пользовательского интерфейса

### 2.1 Главное меню бота
**Команды и кнопки:**

```
/start - Запуск бота
┌─────────────────────────────┐
│  🎬 Обработать видео        │
│  ⚙️ Настройки               │
│  📊 Моя статистика          │
│  ❓ Помощь                  │
│  👨‍💼 Админ-панель (для админов)│
└─────────────────────────────┘
```

### 2.2 Меню "🎬 Обработать видео"
```
┌─────────────────────────────┐
│  📎 Вставить ссылку         │
│  📁 Загрузить файл          │
│  📋 Пакетная обработка      │
│  🔄 Мои задачи              │
│  ⬅️ Назад                   │
└─────────────────────────────┘
```

**Процесс обработки:**
1. **Ввод ссылки/файла**
   - Поддержка YouTube, TikTok, Instagram, Vimeo, прямых ссылок
   - Валидация ссылки в реальном времени
   - Предпросмотр информации о видео (длительность, качество)

2. **Настройки нарезки**
   ```
   ⏱️ Длительность фрагментов: [15 сек] [30 сек] [60 сек] [Кастом]
   ⏭️ Пропустить начало: [0 сек] [10 сек] [20 сек] [30 сек]
   📊 Количество фрагментов: [Авто] [5] [10] [15] [Кастом]
   🎯 Качество: [720p] [1080p] [4K]
   ```

3. **Настройки оформления**
   ```
   🎨 Стиль фона:
   ┌─────────────────────────────┐
   │  🌫️ Размытый               │
   │  🎨 Цветной градиент        │
   │  ⚫ Черный                  │
   │  ⚪ Белый                   │
   └─────────────────────────────┘
   
   📝 Заголовки:
   ┌─────────────────────────────┐
   │  ✏️ Верхний заголовок       │
   │  ✏️ Нижний заголовок        │
   │  🎭 Стиль текста            │
   │  🌈 Цвет текста             │
   └─────────────────────────────┘
   
   📋 Субтитры:
   ┌─────────────────────────────┐
   │  ✅ Включить субтитры       │
   │  🌍 Язык: [Авто] [RU] [EN]  │
   │  📍 Позиция субтитров       │
   │  🎨 Стиль субтитров         │
   └─────────────────────────────┘
   ```

### 2.3 Меню "⚙️ Настройки"
```
┌─────────────────────────────┐
│  🎬 Настройки видео         │
│  💾 Настройки сохранения    │
│  🔔 Уведомления             │
│  👤 Профиль                 │
│  ⬅️ Назад                   │
└─────────────────────────────┘
```

**Настройки видео:**
- Качество по умолчанию
- Длительность фрагментов по умолчанию
- Предустановки оформления
- Автоматические заголовки

**Настройки сохранения:**
- Папка в Google Drive
- Формат имени файлов
- Автоматическое удаление исходников
- Создание превью

### 2.4 Меню "📊 Моя статистика"
```
📈 Статистика пользователя:
┌─────────────────────────────┐
│  📹 Обработано видео: 25    │
│  ⏱️ Время обработки: 2ч 15м │
│  💾 Размер файлов: 1.2 ГБ   │
│  📅 Последняя активность    │
│  📊 График активности       │
└─────────────────────────────┘

┌─────────────────────────────┐
│  📋 История обработки       │
│  📁 Мои файлы в Drive       │
│  📈 Детальная статистика    │
└─────────────────────────────┘
```

### 2.5 Админ-панель "👨‍💼 Админ-панель"
```
┌─────────────────────────────┐
│  📊 Общая статистика        │
│  👥 Управление пользователями│
│  ⚙️ Настройки сервера       │
│  📋 Журнал операций         │
│  🔄 Управление задачами     │
│  💰 Биллинг и лимиты        │
│  🛠️ Техническая информация  │
└─────────────────────────────┘
```

---

## 3. Детальный функционал

### 3.1 Система обработки видео

#### 3.1.1 Скачивание видео
**Функции:**
- Поддержка множественных источников (YouTube, TikTok, Instagram, Vimeo, прямые ссылки)
- Автоматический выбор качества
- Возобновление прерванных загрузок
- Проверка на дубликаты
- Оценка времени загрузки

**Техническая реализация:**
```python
class VideoDownloader:
    def download_video(self, url, quality='best'):
        # Определение источника
        # Валидация ссылки
        # Скачивание с прогресс-баром
        # Сохранение метаданных
        pass
    
    def get_video_info(self, url):
        # Получение информации о видео
        # Длительность, качество, размер
        pass
```

#### 3.1.2 Нарезка видео
**Параметры нарезки:**
- Длительность фрагментов: 15, 30, 60 секунд или кастомная
- Пропуск начала: 0-60 секунд
- Умная нарезка по сценам (опционально)
- Fade-in/fade-out эффекты
- Удаление тишины

**Алгоритм:**
1. Анализ видео (длительность, качество)
2. Расчет количества фрагментов
3. Определение точек нарезки
4. Параллельная обработка фрагментов
5. Проверка качества результатов

#### 3.1.3 Преобразование в Shorts формат
**Технические характеристики:**
- Разрешение: 1080x1920 (9:16)
- Частота кадров: 30 FPS
- Битрейт: 8-12 Mbps
- Кодек: H.264
- Аудио: AAC, 44.1kHz

**Процесс обработки:**
1. **Создание фона:**
   - Размытие исходного видео (Gaussian blur, radius=20)
   - Масштабирование до 1080x1920
   - Опциональные цветовые фильтры

2. **Размещение основного видео:**
   - Центрирование по горизонтали
   - Автоматическое масштабирование
   - Сохранение пропорций

3. **Добавление элементов интерфейса:**
   - Заголовки (верхний/нижний)
   - Логотип/водяной знак
   - Индикаторы прогресса

#### 3.1.4 Система субтитров
**Возможности:**
- Автоматическое распознавание речи (OpenAI Whisper)
- Поддержка множественных языков
- Настраиваемый стиль текста
- Позиционирование субтитров
- Синхронизация с аудио

**Стили субтитров:**
```python
subtitle_styles = {
    'classic': {
        'font': 'Arial Bold',
        'size': 48,
        'color': 'white',
        'stroke': 'black',
        'stroke_width': 2
    },
    'modern': {
        'font': 'Roboto Bold',
        'size': 52,
        'color': 'white',
        'background': 'rgba(0,0,0,0.7)',
        'padding': 10
    },
    'colorful': {
        'font': 'Impact',
        'size': 56,
        'color': 'yellow',
        'stroke': 'black',
        'stroke_width': 3
    }
}
```

### 3.2 Система управления задачами

#### 3.2.1 Очередь задач (Celery)
**Типы задач:**
- `download_video` - Скачивание видео
- `cut_video` - Нарезка на фрагменты
- `process_fragment` - Обработка фрагмента
- `generate_subtitles` - Генерация субтитров
- `upload_to_drive` - Загрузка в Google Drive
- `update_spreadsheet` - Обновление таблицы

**Приоритеты задач:**
- Высокий: Генерация превью, быстрые операции
- Средний: Нарезка, генерация субтитров
- Низкий: Загрузка в облако, архивирование

#### 3.2.2 Мониторинг процессов
**Метрики:**
- Время выполнения задач
- Использование CPU/RAM
- Размер очереди
- Количество ошибок
- Пропускная способность

### 3.3 Интеграции с внешними сервисами

#### 3.3.1 Google Drive API
**Функции:**
- Автоматическое создание папок по датам
- Загрузка видео с метаданными
- Создание превью (скриншоты)
- Управление правами доступа
- Автоматическая очистка старых файлов

**Структура папок:**
```
VideoBot/
├── 2024/
│   ├── January/
│   │   ├── User_123/
│   │   │   ├── video_001.mp4
│   │   │   ├── video_001_preview.jpg
│   │   │   └── metadata.json
```

#### 3.3.2 Google Sheets API
**Структура таблицы:**
| Дата | Пользователь | Исходная ссылка | Количество фрагментов | Время обработки | Ссылка на Drive | Статус |
|------|--------------|-----------------|----------------------|-----------------|-----------------|---------|
| 2024-01-15 | @username | youtube.com/... | 8 | 3:45 | drive.google.com/... | Готово |

**Автоматические функции:**
- Создание отчетов
- Статистика по пользователям
- Мониторинг использования ресурсов
- Биллинг и лимиты

---

## 4. Техническая архитектура

### 4.1 Структура проекта
```
video_bot/
├── app/
│   ├── __init__.py
│   ├── main.py                 # Точка входа
│   ├── bot/
│   │   ├── __init__.py
│   │   ├── handlers/           # Обработчики команд
│   │   │   ├── user_handlers.py
│   │   │   ├── admin_handlers.py
│   │   │   ├── video_handlers.py
│   │   │   └── settings_handlers.py
│   │   ├── keyboards/          # Клавиатуры
│   │   │   ├── main_menu.py
│   │   │   ├── admin_menu.py
│   │   │   └── settings_menu.py
│   │   ├── middlewares/        # Промежуточное ПО
│   │   │   ├── auth_middleware.py
│   │   │   ├── logging_middleware.py
│   │   │   └── throttling_middleware.py
│   │   └── utils/              # Утилиты
│   │       ├── decorators.py
│   │       ├── validators.py
│   │       └── helpers.py
│   ├── video_processing/
│   │   ├── __init__.py
│   │   ├── downloader.py       # Скачивание видео
│   │   ├── cutter.py           # Нарезка видео
│   │   ├── editor.py           # Редактирование
│   │   ├── subtitles.py        # Генерация субтитров
│   │   └── converter.py        # Конвертация форматов
│   ├── services/
│   │   ├── __init__.py
│   │   ├── google_drive.py     # Google Drive API
│   │   ├── google_sheets.py    # Google Sheets API
│   │   ├── storage.py          # Локальное хранилище
│   │   └── cache.py            # Кэширование
│   ├── workers/
│   │   ├── __init__.py
│   │   ├── celery_app.py       # Конфигурация Celery
│   │   ├── video_tasks.py      # Задачи обработки видео
│   │   └── upload_tasks.py     # Задачи загрузки
│   ├── database/
│   │   ├── __init__.py
│   │   ├── models.py           # Модели данных
│   │   ├── connection.py       # Подключение к БД
│   │   └── migrations/         # Миграции
│   ├── config/
│   │   ├── __init__.py
│   │   ├── settings.py         # Настройки приложения
│   │   ├── logging.py          # Конфигурация логирования
│   │   └── constants.py        # Константы
│   └── tests/
│       ├── __init__.py
│       ├── test_video_processing.py
│       ├── test_integrations.py
│       └── test_bot_handlers.py
├── requirements.txt
├── Dockerfile
├── docker-compose.yml
├── .env.example
├── README.md
└── docs/
    ├── api.md
    ├── deployment.md
    └── user_guide.md
```

### 4.2 База данных (MySQL)

#### Схема базы данных:
```sql
-- Пользователи
CREATE TABLE users (
    id BIGINT PRIMARY KEY,
    username VARCHAR(255),
    first_name VARCHAR(255),
    last_name VARCHAR(255),
    is_admin BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    settings JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Видео-задачи
CREATE TABLE video_tasks (
    id VARCHAR(36) PRIMARY KEY,
    user_id BIGINT,
    source_url TEXT,
    original_filename VARCHAR(500),
    status ENUM('pending', 'downloading', 'processing', 'uploading', 'completed', 'failed'),
    settings JSON,
    progress INT DEFAULT 0,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP NULL,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- Обработанные фрагменты
CREATE TABLE video_fragments (
    id VARCHAR(36) PRIMARY KEY,
    task_id VARCHAR(36),
    fragment_number INT,
    filename VARCHAR(500),
    drive_url TEXT,
    preview_url TEXT,
    duration DECIMAL(8,3),
    size_bytes BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES video_tasks(id)
);

-- Статистика
CREATE TABLE user_statistics (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT,
    date DATE,
    videos_processed INT DEFAULT 0,
    total_duration DECIMAL(10,3) DEFAULT 0,
    total_size_bytes BIGINT DEFAULT 0,
    UNIQUE KEY unique_user_date (user_id, date),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- Настройки системы
CREATE TABLE system_settings (
    key_name VARCHAR(100) PRIMARY KEY,
    value JSON,
    description TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```


#### Dockerfile
```dockerfile
FROM python:3.11-slim

# Установка системных зависимостей
RUN apt-get update && apt-get install -y \
    ffmpeg \
    redis-server \
    mysql-client \
    && rm -rf /var/lib/apt/lists/*

# Установка Python зависимостей
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Копирование кода приложения
COPY app/ /app/
WORKDIR /app

# Создание необходимых директорий
RUN mkdir -p /tmp/videos /tmp/processed

# Переменные окружения
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1

# Порт для health check
EXPOSE 8000

# Команда запуска
CMD ["python", "main.py"]
```

---

## 5. Детальное описание этапов разработки

### Этап 1: Подготовка и настройка (2-3 дня)

#### День 1: Инициализация проекта
- [ ] Создание структуры проекта
- [ ] Настройка виртуального окружения
- [ ] Установка и настройка зависимостей
- [ ] Создание базовой конфигурации
- [ ] Инициализация Git репозитория
- [ ] Создание проекта в Railway
- [ ] Настройка переменных окружения

#### День 2: Настройка инфраструктуры
- [ ] Настройка MySQL базы данных
- [ ] Создание и применение миграций
- [ ] Настройка Redis для Celery
- [ ] Конфигурация Celery workers
- [ ] Создание Google Cloud проекта
- [ ] Настройка Google Drive API
- [ ] Настройка Google Sheets API

#### День 3: Базовая настройка бота
- [ ] Создание Telegram бота через BotFather
- [ ] Реализация базовой структуры бота
- [ ] Настройка middleware и logging
- [ ] Создание основных меню
- [ ] Тестирование базового функционала
- [ ] Настройка CI/CD pipeline

### Этап 2: Разработка основного функционала (10-14 дней)

#### Неделя 1: Система скачивания и нарезки

**Дни 1-2: Модуль скачивания видео**
- [ ] Реализация VideoDownloader класса
- [ ] Интеграция с yt-dlp
- [ ] Поддержка множественных источников
- [ ] Валидация ссылок
- [ ] Прогресс-бар скачивания
- [ ] Обработка ошибок
- [ ] Тестирование с различными источниками

**Дни 3-4: Модуль нарезки видео**
- [ ] Реализация VideoCutter класса
- [ ] Интеграция с FFmpeg
- [ ] Алгоритмы умной нарезки
- [ ] Параллельная обработка фрагментов
- [ ] Оптимизация производительности
- [ ] Обработка различных форматов
- [ ] Unit тесты

**Дни 5-7: Интеграция с Telegram ботом**
- [ ] Handlers для обработки ссылок
- [ ] Система настроек нарезки
- [ ] Прогресс-индикаторы в боте
- [ ] Обработка пользовательского ввода
- [ ] Валидация параметров
- [ ] Error handling
- [ ] Интеграционные тесты

#### Неделя 2: Обработка и оформление видео

**Дни 8-9: Конвертация в Shorts формат**
- [ ] Реализация VideoConverter класса
- [ ] Создание размытого фона
- [ ] Центрирование основного видео
- [ ] Поддержка различных соотношений сторон
- [ ] Настройки качества
- [ ] Оптимизация размера файлов

**Дни 10-11: Система субтитров**
- [ ] Интеграция OpenAI Whisper
- [ ] Автоматическое распознавание языка
- [ ] Генерация SRT файлов
- [ ] Встраивание субтитров в видео
- [ ] Настройки стилей текста
- [ ] Позиционирование субтитров

**Дни 12-14: Система заголовков и оформления**
- [ ] Добавление текстовых заголовков
- [ ] Система шаблонов оформления
- [ ] Настройки шрифтов и цветов
- [ ] Анимированные элементы
- [ ] Водяные знаки
- [ ] Предварительный просмотр

### Этап 3: Интеграции и экспорт (4-6 дней)

#### Дни 1-2: Google Drive интеграция
- [ ] Реализация GoogleDriveService
- [ ] Автоматическое создание папок
- [ ] Загрузка видео файлов
- [ ] Создание превью изображений
- [ ] Управление правами доступа
- [ ] Мониторинг квот API

#### Дни 3-4: Google Sheets интеграция
- [ ] Реализация GoogleSheetsService
- [ ] Автоматическое создание таблиц
- [ ] Запись метаданных
- [ ] Формирование отчетов
- [ ] Статистика по пользователям
- [ ] Экспорт данных

#### Дни 5-6: Система уведомлений и мониторинга
- [ ] Push уведомления в боте
- [ ] Email уведомления (опционально)
- [ ] Система логирования
- [ ] Мониторинг производительности
- [ ] Алерты при ошибках
- [ ] Dashboard для мониторинга

### Этап 4: Административная панель (4-6 дней)

#### Дни 1-2: Управление пользователями
- [ ] Система ролей и разрешений
- [ ] Блокировка/разблокировка пользователей
- [ ] Статистика по пользователям
- [ ] Управление лимитами
- [ ] Модерация контента

#### Дни 3-4: Настройки системы
- [ ] Конфигурация параметров обработки
- [ ] Управление очередями задач
- [ ] Настройки интеграций
- [ ] Резервное копирование
- [ ] Обновление системы

#### Дни 5-6: Аналитика и отчеты
- [ ] Dashboard с метриками
- [ ] Графики использования
- [ ] Отчеты по производительности
- [ ] Финансовая аналитика
- [ ] Экспорт отчетов

### Этап 5: Тестирование и оптимизация (3-5 дней)

#### Дни 1-2: Функциональное тестирование
- [ ] Unit тесты для всех модулей
- [ ] Интеграционные тесты
- [ ] End-to-end тестирование
- [ ] Тестирование производительности
- [ ] Нагрузочное тестирование

#### Дни 3-4: Оптимизация
- [ ] Профилирование производительности
- [ ] Оптимизация использования памяти
- [ ] Настройка кэширования
- [ ] Оптимизация базы данных
- [ ] Сжатие видео файлов

#### День 5: Финальная подготовка
- [ ] Подготовка документации
- [ ] Создание инструкций для пользователей
- [ ] Финальное тестирование
- [ ] Подготовка к деплою

### Этап 6: Развертывание на Railway (1-2 дня)

#### День 1: Подготовка к деплою
- [ ] Финализация конфигурации Railway
- [ ] Настройка production окружения
- [ ] Конфигурация автоскейлинга
- [ ] Настройка мониторинга
- [ ] Подготовка volumes для постоянного хранилища

#### День 2: Деплой и мониторинг
- [ ] Деплой в production
- [ ] Настройка автоматического деплоя
- [ ] Тестирование в production среде
- [ ] Настройка алертов
- [ ] Мониторинг производительности
- [ ] Документация по эксплуатации

---

## 6. Технические требования и ограничения

### 6.1 Системные требования
- **CPU**: Минимум 2 ядра, рекомендуется 4+ ядер
- **RAM**: Минимум 4GB, рекомендуется 8GB+
- **Диск**: Минимум 50GB свободного места
- **Сеть**: Стабильное подключение к интернету

### 6.2 Лимиты обработки
- Максимальная длительность видео: 3 часа
- Максимальный размер файла: 2GB
- Одновременно обрабатываемых видео: 5
- Максимальное количество фрагментов: 100

### 6.3 API лимиты
- Google Drive API: 1000 запросов/час
- Google Sheets API: 100 запросов/секунду
- Telegram Bot API: 30 сообщений/секунду
- OpenAI Whisper: без ограничений (локальная)

---

## 7. Мониторинг и метрики

### 7.1 Ключевые метрики
- Время обработки видео
- Успешность операций (%)
- Использование ресурсов
- Количество активных пользователей
- Размер обработанного контента

### 7.2 Алерты
- Превышение времени обработки
- Ошибки в критических процессах
- Превышение лимитов API
- Нехватка дискового пространства
- Высокая нагрузка на систему

---

## 8. Безопасность

### 8.1 Аутентификация и авторизация
- Система ролей (Пользователь, Модератор, Админ)
- Проверка прав доступа
- Логирование действий пользователей
- Защита от спама и злоупотреблений

### 8.2 Защита данных
- Шифрование чувствительных данных
- Безопасное хранение API ключей
- Регулярные резервные копии
- Защита от SQL инъекций
- Валидация пользовательского ввода

---

## 9. Масштабирование

### 9.1 Горизонтальное масштабирование
- Множественные Celery workers
- Load balancing для Telegram webhooks
- Распределенное хранение файлов
- Кэширование частых запросов

### 9.2 Вертикальное масштабирование
- Автоматическое увеличение ресурсов
- Мониторинг нагрузки
- Оптимизация алгоритмов
- Сжатие данных

---

## 10. Стоимость и ресурсы

### 10.1 Примерная стоимость на Railway
- **Starter Plan**: $5/месяц (для разработки)
- **Pro Plan**: $20/месяц (для production)
- **Дополнительные ресурсы**: по мере необходимости

### 10.2 Внешние сервисы
- Google Cloud Storage: ~$0.02/GB в месяц
- Google Drive API: бесплатно до лимитов
- Google Sheets API: бесплатно до лимитов
- Домен (опционально): ~$10/год

---

## Заключение

Данный план предоставляет детальный roadmap для создания полнофункционального Telegram бота для автоматической нарезки и обработки видео. Проект включает в себя современные технологии, масштабируемую архитектуру и профессиональный подход к разработке.

**Ключевые преимущества проекта:**
1. **Автоматизация**: Полная автоматизация процесса от ссылки до готового контента
2. **Качество**: Профессиональное оформление с субтитрами и эффектами
3. **Масштабируемость**: Готовность к росту пользовательской базы
4. **Удобство**: Интуитивный интерфейс в Telegram
5. **Надежность**: Система мониторинга и обработки ошибок

**Общая оценка сроков: 20-30 рабочих дней**

Проект готов к реализации и может быть адаптирован под специфические требования заказчика.